# NeoRealm API and Database Documentation

## Database Schema

### Profiles Table
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  username TEXT UNIQUE NOT NULL,
  avatar_url TEXT,
  character_class TEXT,
  bio TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### Fields
- `id`: UUID, primary key, references auth.users(id)
- `username`: Unique text identifier for the character
- `avatar_url`: URL to the character's avatar image
- `character_class`: Character class (e.g., NetRunner, Corporate)
- `bio`: Character biography
- `created_at`: Timestamp of profile creation

### Messages Table
```sql
CREATE TABLE messages (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id UUID REFERENCES profiles(id),
  content TEXT,
  message_type TEXT CHECK (message_type IN ('chat', 'action', 'dice_roll', 'system')),
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### Fields
- `id`: Auto-generated BIGINT primary key
- `user_id`: UUID referencing the profile of the message author
- `content`: Text content of the message
- `message_type`: Type of message (chat, action, dice_roll, system)
- `created_at`: Timestamp of message creation

### Followers Table
```sql
CREATE TABLE followers (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  follower_id UUID REFERENCES profiles(id),
  following_id UUID REFERENCES profiles(id),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(follower_id, following_id)
);
```

#### Fields
- `id`: Auto-generated BIGINT primary key
- `follower_id`: UUID of the user following someone
- `following_id`: UUID of the user being followed
- `created_at`: Timestamp of follow action
- `UNIQUE(follower_id, following_id)`: Prevents duplicate follows

### Reactions Table
```sql
CREATE TABLE reactions (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  user_id UUID REFERENCES profiles(id),
  message_id BIGINT REFERENCES messages(id),
  reaction_type TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### Fields
- `id`: Auto-generated BIGINT primary key
- `user_id`: UUID of the user reacting
- `message_id`: BIGINT referencing the message
- `reaction_type`: Type of reaction (energy)
- `created_at`: Timestamp of reaction

## Supabase Edge Functions API

### Welcome User Function
**Endpoint**: `https://YOUR_SUPABASE_PROJECT.functions.supabase.co/welcome-user`

**Method**: POST (triggered by database hook)

**Request Body**:
```json
{
  "record": {
    "id": "user_uuid",
    "username": "character_name",
    // other profile fields
  }
}
```

**Response**:
```json
{
  "message": "Welcome message sent successfully"
}
```

### Architect Bot Function
**Endpoint**: `https://YOUR_SUPABASE_PROJECT.functions.supabase.co/architect-bot`

**Method**: POST (triggered by CRON job)

**Request Body**:
```json
{}
```

**Response**:
```json
{
  "message": "System message sent successfully"
}
```

## Frontend API Usage

### Authentication
The frontend uses Supabase Auth for user authentication:

```typescript
// Sign up
const { data, error } = await supabase.auth.signUp({
  email: 'user@example.com',
  password: 'password'
});

// Sign in
const { data, error } = await supabase.auth.signInWithPassword({
  email: 'user@example.com',
  password: 'password'
});

// Sign out
await supabase.auth.signOut();
```

### Profile Management
```typescript
// Get user profile
const { data, error } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', user.id)
  .single();

// Create/update profile
const { data, error } = await supabase
  .from('profiles')
  .upsert({
    id: user.id,
    username: 'new_username',
    character_class: 'NetRunner',
    bio: 'Character bio'
  });
```

### Messaging
```typescript
// Get messages
const { data, error } = await supabase
  .from('messages')
  .select(`
    id,
    user_id,
    content,
    message_type,
    created_at,
    profiles:profiles(id, username, avatar_url, character_class),
    reactions(*)
  `)
  .order('created_at', { ascending: true })
  .limit(50);

// Send message
const { data, error } = await supabase
  .from('messages')
  .insert([
    {
      user_id: profile.id,
      content: 'Message content',
      message_type: 'chat'
    }
  ]);

// Subscribe to new messages
const channel = supabase
  .channel('messages')
  .on(
    'postgres_changes',
    {
      event: 'INSERT',
      schema: 'public',
      table: 'messages'
    },
    (payload) => {
      // Handle new message
    }
  )
  .subscribe();
```

### Social Features
```typescript
// Follow a user
const { data, error } = await supabase
  .from('followers')
  .insert([
    {
      follower_id: currentUser.id,
      following_id: targetUser.id
    }
  ]);

// Get followers
const { data, error } = await supabase
  .from('followers')
  .select('follower_id')
  .eq('following_id', user.id);

// React to message
const { data, error } = await supabase
  .from('reactions')
  .insert([
    {
      user_id: profile.id,
      message_id: messageId,
      reaction_type: 'energy'
    }
  ]);
```

## Environment Variables

### Required Variables
- `NEXT_PUBLIC_SUPABASE_URL`: Your Supabase project URL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Your Supabase anon key

### Supabase Function Variables
These are set automatically by Supabase:
- `SUPABASE_URL`: Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY`: Service role key for functions

## Database Indexes

The schema includes several indexes for performance optimization:

```sql
CREATE INDEX IF NOT EXISTS messages_created_at_idx ON messages (created_at);
CREATE INDEX IF NOT EXISTS followers_follower_id_idx ON followers (follower_id);
CREATE INDEX IF NOT EXISTS followers_following_id_idx ON followers (following_id);
CREATE INDEX IF NOT EXISTS reactions_message_id_idx ON reactions (message_id);
```

## Security Considerations

1. Row Level Security (RLS) should be enabled on all tables
2. Policies should restrict access to user data
3. Service role key should only be used in Edge Functions
4. Anon key is safe for frontend use but has limited permissions
5. User input should be validated and sanitized

## Database Policies

Example policies that should be implemented:

```sql
-- Profiles policies
CREATE POLICY "Profiles are viewable by everyone" ON profiles
  FOR SELECT USING (true);

CREATE POLICY "Users can insert their own profile" ON profiles
  FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update their own profile" ON profiles
  FOR UPDATE USING (auth.uid() = id);

-- Messages policies
CREATE POLICY "Messages are viewable by everyone" ON messages
  FOR SELECT USING (true);

CREATE POLICY "Users can insert their own messages" ON messages
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Followers policies
CREATE POLICY "Follow relationships are viewable by everyone" ON followers
  FOR SELECT USING (true);

CREATE POLICY "Users can insert their own follows" ON followers
  FOR INSERT WITH CHECK (auth.uid() = follower_id);

CREATE POLICY "Users can delete their own follows" ON followers
  FOR DELETE USING (auth.uid() = follower_id);

-- Reactions policies
CREATE POLICY "Reactions are viewable by everyone" ON reactions
  FOR SELECT USING (true);

CREATE POLICY "Users can insert their own reactions" ON reactions
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can delete their own reactions" ON reactions
  FOR DELETE USING (auth.uid() = user_id);
```